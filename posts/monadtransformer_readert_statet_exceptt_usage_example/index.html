<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.55" />
    <meta name="keywords" content="Kendrick Tan,Linux,Software,Backend,Frontend,Fullstack,Data Science,Haskell,Functional Programming,Machine Learning,Blockchain,Python,Web Development" />
    <meta name="description" content="I'm Kendrick Tan, a Software Engineer. I enjoy writing clean and maintainable code." />
    
    <title>MonadTransformers - ReaderT, StateT, ExceptT Usage Example | Kendrick Tan</title>
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" />
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css" />
    <link rel="stylesheet" href="//cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css" />
    <link rel="stylesheet" type="text/css" href="../../assets/css/simple-grid.min.css" />
    <link rel="stylesheet" type="text/css" href="../../assets/css/default.css" />
    <link rel="stylesheet" type="text/css" href="../../assets/css/syntax.css" />
    <link href="../../assets/images/fav.png" rel="shortcut icon" />
    <meta name="google-site-verification" content="URddx6H5g_y_Y0QQSKvLFPZDSBZegLj4J1VCdqEvoBw" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-71060764-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-71060764-2');
</script>

    
    
  </head>
  <body>
    <div class="navigation">
      <ul class="navigation_list">
        <li class="navigation_item"><a href="../../">Home</a></li>
        <li class="navigation_item"><a href="../../posts/">Posts</a></li>
        <li class="navigation_item"><a href="../../projects/">Projects</a></li>
        <li class="navigation_item"><a href="https://goo.gl/m2EgR2">Resume</a></li>
        <li class="navigation_item"><a href="../../talks/">Talks</a></li>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="content">
            
            <h1>MonadTransformers - ReaderT, StateT, ExceptT Usage Example</h1>
             <div class="info">
    Posted on 2018-12-17    
    
        by Kendrick Tan
    
</div>

<br />

<div class="content-body">

<h1 id="prelude">Prelude</h1>
<p>Before starting out my last Haskell project, I’ve been trying usage examples for <code>ExceptT</code> nested within <code>StateT</code> and other MonadTransformers. Only problem is that I couldn’t really find any nice examples without the constant usage of <code>lift</code>.</p>
<p>I was thinking about writing a long winded blog post, but code is more powerful than words (<a href="https://two-wrongs.com/a-gentle-introduction-to-monad-transformers">and people have done it better than I could</a>), so I decided to keep the writing minimal, and show mainly the code examples.</p>
<h1 id="background">Background</h1>
<p>The pattern we’re trying to abstract is:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">pattern ::</span> <span class="dt">Env</span> <span class="ot">-&gt;</span> <span class="dt">State</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">Error</span> a)</code></pre></div>
<p>Which can be done so using three monad transformers:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- pattern and pattern' are exactly the same</span>
<span class="ot">pattern' ::</span> <span class="dt">ReaderT</span> <span class="dt">Env</span> (<span class="dt">StateT</span> <span class="dt">State</span> (<span class="dt">ExceptT</span> <span class="dt">Error</span> <span class="dt">IO</span>)) a</code></pre></div>
<h1 id="example">Example</h1>
<p>You can download and run the example below <a href="https://github.com/kendricktan/monadtransformers-example">from this repository</a>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE ConstraintKinds            #-}</span>
<span class="ot">{-# LANGUAGE DeriveGeneric              #-}</span>
<span class="ot">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span>

<span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span>

<span class="kw">import           </span><span class="dt">Control.Monad</span>
<span class="kw">import           </span><span class="dt">Control.Monad.Except</span>
<span class="kw">import           </span><span class="dt">Control.Monad.Reader</span>
<span class="kw">import           </span><span class="dt">Control.Monad.State.Lazy</span>

<span class="co">-- | Monad Declaration (ReaderT -&gt; StateT -&gt; ExceptT)</span>
<span class="co">--</span>
<span class="kw">data</span> <span class="dt">MyEnvironment</span> <span class="fu">=</span> <span class="dt">MyEnvironment</span>
  {<span class="ot"> envStr ::</span> <span class="dt">String</span>
  ,<span class="ot"> envInt ::</span> <span class="dt">Int</span>
  } <span class="kw">deriving</span> <span class="dt">Show</span>

<span class="kw">data</span> <span class="dt">MyState</span> <span class="fu">=</span> <span class="dt">MyState</span>
  {<span class="ot"> stateStr ::</span> <span class="dt">String</span>
  ,<span class="ot"> stateInt ::</span> <span class="dt">Int</span>
  } <span class="kw">deriving</span> <span class="dt">Show</span>

<span class="kw">data</span> <span class="dt">MyError</span> <span class="fu">=</span> <span class="dt">ErrorNumberOne</span> <span class="dt">Int</span>
             <span class="fu">|</span> <span class="dt">ErrorNumberTwo</span>
             <span class="fu">|</span> <span class="dt">UnknownError</span>
             <span class="kw">deriving</span> <span class="dt">Show</span>

<span class="kw">newtype</span> <span class="dt">MyMonad</span> a <span class="fu">=</span> <span class="dt">MyMonad</span> (<span class="dt">ReaderT</span> <span class="dt">MyEnvironment</span> (<span class="dt">StateT</span> <span class="dt">MyState</span> (<span class="dt">ExceptT</span> <span class="dt">MyError</span> <span class="dt">IO</span>)) a)
  <span class="kw">deriving</span> ( <span class="dt">Functor</span>
           , <span class="dt">Applicative</span>
           , <span class="dt">Monad</span>
           , <span class="dt">MonadReader</span> <span class="dt">MyEnvironment</span>
           , <span class="dt">MonadState</span> <span class="dt">MyState</span>
           , <span class="dt">MonadError</span> <span class="dt">MyError</span>
           , <span class="dt">MonadIO</span>
           )

<span class="co">-- Helper functions</span>
<span class="co">--</span>
<span class="ot">runMyMonad ::</span> <span class="dt">MyEnvironment</span> <span class="ot">-&gt;</span> <span class="dt">MyState</span> <span class="ot">-&gt;</span> <span class="dt">MyMonad</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">MyError</span> a)
runMyMonad env state (<span class="dt">MyMonad</span> m) <span class="fu">=</span> runExceptT s
  <span class="kw">where</span> r <span class="fu">=</span> runReaderT m env
        s <span class="fu">=</span> evalStateT r state

<span class="ot">initialEnvironment ::</span> <span class="dt">MyEnvironment</span>
initialEnvironment <span class="fu">=</span> <span class="dt">MyEnvironment</span> <span class="st">&quot;Gotta go fast&quot;</span> <span class="dv">42</span>

<span class="ot">initialState ::</span> <span class="dt">MyState</span>
initialState <span class="fu">=</span> <span class="dt">MyState</span> <span class="st">&quot;Double Cheese Burgers&quot;</span> <span class="dv">0</span>

<span class="co">-- | Usage Examples</span>
<span class="co">--</span>

<span class="co">-- Reads from environment and outputs to stdout</span>
<span class="co">-- printEnvValue and printEnvValue' are the same</span>
<span class="co">-- just with/without the do syntax sugar</span>
<span class="ot">printEnvValue ::</span> <span class="dt">MyMonad</span> ()
printEnvValue <span class="fu">=</span> ask <span class="fu">&gt;&gt;=</span> liftIO <span class="fu">.</span> print

<span class="ot">printEnvValue' ::</span> <span class="dt">MyMonad</span> ()
printEnvValue' <span class="fu">=</span> <span class="kw">do</span>
  r <span class="ot">&lt;-</span> ask
  liftIO <span class="fu">.</span> print <span class="fu">$</span> r

<span class="ot">printStateValue ::</span> <span class="dt">MyMonad</span> ()
printStateValue <span class="fu">=</span> get <span class="fu">&gt;&gt;=</span> liftIO <span class="fu">.</span> print

<span class="ot">printStateValue' ::</span> <span class="dt">MyMonad</span> ()
printStateValue' <span class="fu">=</span> <span class="kw">do</span>
  s <span class="ot">&lt;-</span> get
  liftIO <span class="fu">.</span> print <span class="fu">$</span> s

<span class="co">-- If its given an even value, it'll update</span>
<span class="co">-- the state value to the given value,</span>
<span class="co">-- otherwise it'll update the state value</span>
<span class="co">-- to be the same value from the Environment (reader)</span>
<span class="ot">envReadStateUpdate ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">MyMonad</span> ()
envReadStateUpdate i <span class="fu">=</span> <span class="kw">do</span>
  <span class="co">-- Print State Value</span>
  liftIO <span class="fu">$</span> putStrLn <span class="st">&quot;Initial state value: &quot;</span>
  printStateValue
  <span class="kw">case</span> i <span class="ot">`rem`</span> <span class="dv">2</span> <span class="kw">of</span>
     <span class="co">-- Updates stateInt value</span>
     <span class="dv">0</span> <span class="ot">-&gt;</span> modify (\s <span class="ot">-&gt;</span> s { stateInt <span class="fu">=</span> i } )
     _ <span class="ot">-&gt;</span> <span class="kw">do</span>
       <span class="co">-- Gets the environment's Int value</span>
       r <span class="ot">&lt;-</span> asks envInt
       modify (\s <span class="ot">-&gt;</span> s { stateInt <span class="fu">=</span> r } )
  liftIO <span class="fu">$</span> putStrLn <span class="st">&quot;Final state value: &quot;</span>
  printStateValue'

<span class="co">-- Exception handling</span>
<span class="ot">errorHandler ::</span> <span class="dt">MyError</span> <span class="ot">-&gt;</span> <span class="dt">MyMonad</span> ()
errorHandler (<span class="dt">ErrorNumberOne</span> i) <span class="fu">=</span> modify (\s <span class="ot">-&gt;</span> s { stateInt <span class="fu">=</span> i })
errorHandler <span class="dt">ErrorNumberTwo</span>     <span class="fu">=</span> modify (\s <span class="ot">-&gt;</span> s { stateInt <span class="fu">=</span> <span class="dv">2</span> })
errorHandler <span class="dt">UnknownError</span>       <span class="fu">=</span> modify (\s <span class="ot">-&gt;</span> s { stateInt <span class="fu">=</span> <span class="fu">-</span><span class="dv">1</span> })

<span class="ot">logicHandler ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">MyMonad</span> ()
logicHandler i <span class="fu">=</span> <span class="kw">case</span> i <span class="ot">`rem`</span> <span class="dv">3</span> <span class="kw">of</span>
                  <span class="dv">0</span> <span class="ot">-&gt;</span> liftIO (putStrLn <span class="st">&quot;Divisible by 3!&quot;</span>) <span class="fu">&gt;&gt;</span> return ()
                  <span class="dv">1</span> <span class="ot">-&gt;</span> throwError <span class="fu">$</span> <span class="dt">ErrorNumberOne</span> i
                  <span class="dv">2</span> <span class="ot">-&gt;</span> throwError <span class="dt">ErrorNumberTwo</span>
                  _ <span class="ot">-&gt;</span> throwError <span class="dt">UnknownError</span>

<span class="ot">handleExceptions ::</span> [<span class="dt">Int</span>] <span class="ot">-&gt;</span> <span class="dt">MyMonad</span> ()
handleExceptions []       <span class="fu">=</span> return ()
handleExceptions (x <span class="fu">:</span> xs) <span class="fu">=</span> <span class="kw">do</span>
  liftIO <span class="fu">$</span> putStrLn <span class="fu">$</span> <span class="st">&quot;Obtained integer: &quot;</span> <span class="fu">++</span> (show x)
  liftIO <span class="fu">$</span> putStrLn <span class="st">&quot;Initial state value: &quot;</span>
  printStateValue
  (logicHandler x) <span class="ot">`catchError`</span> (\e <span class="ot">-&gt;</span> liftIO (putStrLn <span class="st">&quot;Not divisible by 3!&quot;</span>) <span class="fu">&gt;&gt;</span> errorHandler e)
  liftIO <span class="fu">$</span> putStrLn <span class="st">&quot;Final state value: &quot;</span>
  printStateValue
  liftIO <span class="fu">$</span> putStrLn <span class="st">&quot;===================== &quot;</span>
  handleExceptions xs


<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
  putStrLn <span class="st">&quot;1. Reads environment value and outputs to stdout:&quot;</span>
  _ <span class="ot">&lt;-</span> runMyMonad initialEnvironment initialState printEnvValue
  putStrLn <span class="st">&quot;\n\n2. Reads state value and outputs to stdout&quot;</span>
  _ <span class="ot">&lt;-</span> runMyMonad initialEnvironment initialState printStateValue
  putStrLn <span class="st">&quot;\n\n3. Updates state value to 16 (since it's an even number)&quot;</span>
  _ <span class="ot">&lt;-</span> runMyMonad initialEnvironment initialState (envReadStateUpdate <span class="dv">16</span>)
  putStrLn <span class="st">&quot;\n\n4. Updates state value to whatever envInt is (since it's an odd number)&quot;</span>
  _ <span class="ot">&lt;-</span> runMyMonad initialEnvironment initialState (envReadStateUpdate <span class="dv">3</span>)
  putStrLn <span class="st">&quot;\n\n5. Exception handling&quot;</span>
  _ <span class="ot">&lt;-</span> runMyMonad initialEnvironment initialState (handleExceptions [<span class="dv">2</span><span class="fu">..</span><span class="dv">5</span>])
  return ()</code></pre></div>

</div>
 
            <hr />
            <div class="block">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = "kendricktangithubio"; 
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
 
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
        <a href="https://github.com/kendricktan">github</a>&nbsp;&nbsp;/&nbsp;&nbsp;
        <a href="https://twitter.com/kendricktrh">twitter</a>&nbsp;&nbsp;/&nbsp;&nbsp;
        <a href="https://www.linkedin.com/in/tankendrick/">linkedin</a>&nbsp;&nbsp;/&nbsp;&nbsp;
          me [at] kndrck.co
    </div>
  </body>
</html>
